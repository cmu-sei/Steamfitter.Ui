<!--
Copyright 2021 Carnegie Mellon University. All Rights Reserved.
Released under a MIT (SEI)-style license. See LICENSE.md in the project root for license information.
-->
<h2 mat-dialog-title>Edit Task
  <button mat-icon-button (click)="handleEditComplete(false)" title="Close" class="close-button" tabindex="-1">
    <mat-icon svgIcon="ic_cancel_circle"></mat-icon>
  </button>
</h2>
<mat-dialog-content>
  <div fxFlex fxLayout="column" class=" content">
    <mat-form-field class="param-full-width">
      <input matInput placeholder="Name" [value]="data.task.name" (input)="data.task.name = $event.target.value">
    </mat-form-field>
    <mat-form-field class="param-full-width">
      <input matInput placeholder="Description" [value]="data.task.description" (input)="data.task.description = $event.target.value">
    </mat-form-field>

    <h2>Action</h2>
    <mat-form-field fxFlex fxFlexFill>
      <mat-select placeholder="Select an Action" [(value)]="selectedCommand" (selectionChange)="onCommandChange()">
        <mat-option *ngFor="let cmd of availableCommands" [value]="cmd">
          {{cmd.api}} - {{cmd.display}}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <div fxFlex fxLayout="column" *ngIf="selectedCommand != undefined" class="content">
      <form class="param-form">
        <div *ngFor="let param of selectedCommand.parameters" class="param-indent">
          <mat-form-field class="param-full-width" *ngIf="param.inputType === 'text' && param.key.toLowerCase() !== 'username'">
            <input matInput placeholder="{{param.display}}" [value]="param.value" (input)="param.value = $event.target.value" (change)="onCommandChange()">
          </mat-form-field>
          <mat-form-field class="param-full-width" *ngIf="param.inputType === 'select'">
            <mat-label>{{param.display}}</mat-label>
            <mat-select  [(ngModel)]="param.value" (selectionChange)="onCommandChange()" name="{{param.key}}">
              <mat-option *ngFor="let choice of param.choices" [value]="choice.key">
                {{choice.display}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <div class="param-full-width" *ngIf="param.inputType === 'file'">
            <input #file id="fileInput" type="file" multiple style="display: none;"
            (change)="loadFileContent(param, file)" />
            <button mat-menu-item (click)="file.click();" >
                Select a Text File (... or enter text below)
            </button>
            <textarea class="mdc-text-field__input" rows="10" cols="160" placeholder="{{param.display}}" [(ngModel)]="param.value" name="content" (change)="onCommandChange()"></textarea>
          </div>
        </div>
      </form>
    </div>
    <mat-form-field class="param-full-width">
      <mat-label>Trigger Condition</mat-label>
      <mat-select  [(ngModel)]="data.task.triggerCondition" name="triggerCondition">
        <mat-option *ngFor="let choice of triggerConditions" [value]="choice">
          {{choice}}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field class="param-full-width">
      <input matInput placeholder="Expected Output" [value]="data.task.expectedOutput" (input)="data.task.expectedOutput = $event.target.value">
    </mat-form-field>

    <h2>Delay / Iteration / Expiration</h2>
    <mat-form-field class="param-full-width">
      <input matInput placeholder="Delay (in seconds) Before Executing This Task" [value]="data.task.delaySeconds" (input)="data.task.delaySeconds = $event.target.value">
    </mat-form-field>
    <mat-form-field class="param-full-width">
      <input matInput placeholder="Number of Iterations" [value]="data.task.iterations" (input)="data.task.iterations = $event.target.value">
    </mat-form-field>
    <mat-form-field class="param-full-width">
      <input matInput placeholder="Interval (in seconds) Between Iterations" [value]="data.task.intervalSeconds" (input)="data.task.intervalSeconds = $event.target.value">
    </mat-form-field>
    <mat-form-field class="param-full-width">
      <mat-label>IterationTermination</mat-label>
      <mat-select [(ngModel)]="data.task.iterationTermination" name="iterationTermination">
        <mat-option *ngFor="let choice of iterationTerminations" [value]="choice">
          {{choice}}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field class="param-full-width">
      <input matInput placeholder="Expiration Timeout (in seconds)" [value]="data.task.expirationSeconds" (input)="data.task.expirationSeconds = $event.target.value">
    </mat-form-field>

    <span *ngIf="credentialsAreRequired()">
      <h2>VM Credentials</h2>
      <app-vm-credentials
        [scenarioTemplateId]="data.task.scenarioTemplateId"
        [scenarioId]="data.task.scenarioId"
        [username]="username | async"
        [password]="password | async"
        (selectedVmCredentialChanged)="handleVmCredentialChange($event)"
      ></app-vm-credentials>
    </span>

    <h2>VM Selection</h2>
    <mat-form-field class="param-full-width" *ngIf="!chooseVms">
      <input matInput placeholder="VM Mask (VM name includes this text)" [value]="data.task.vmMask" (input)="data.task.vmMask = $event.target.value">
    </mat-form-field>
    <mat-checkbox [checked]="chooseVms" (change)="switchChooseVmsMethod($event)" style="margin-right: 20px;" *ngIf="!data.task.scenarioTemplateId">Choose Actual VMs</mat-checkbox>
    <app-vm-list *ngIf="chooseVms"
      [selectedVms]="data.task.vmList || []"
      (updateVmList)="handleUpdateVmList($event)">
    </app-vm-list>

  </div>
</mat-dialog-content>
<mat-dialog-actions align="center">
  <button mat-stroked-button (click)="handleEditComplete(true)" [disabled]="!errorFree()" style="margin-right: 400px;">Save</button>
  <button mat-stroked-button (click)="handleEditComplete(false)">Cancel</button>
</mat-dialog-actions>
